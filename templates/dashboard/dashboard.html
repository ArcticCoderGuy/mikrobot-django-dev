{% load static %}
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroBot - Smart Microscale Trading Platform | Fox-In-The-Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/themes.css' %}" rel="stylesheet">
    <script src="{% static 'js/theme-manager.js' %}" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .smooth-enter {
            animation: slideInUp 0.8s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .number-counter {
            font-variant-numeric: tabular-nums;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        
        .trading-chart {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .logo-glow {
            filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.3));
        }
        
        .metric-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .neon-border {
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
            border: 1px solid rgba(34, 211, 238, 0.5);
        }
        
        .signal-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .signal-item:hover {
            border-left-color: #22d3ee;
            background: rgba(34, 211, 238, 0.05);
        }
        
        .trade-row {
            transition: all 0.2s ease;
        }
        
        .trade-row:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .timeframe-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .timeframe-h1-m15 { background: #10b981; color: white; }
        .timeframe-m15-m5 { background: #f59e0b; color: white; }
        .timeframe-m5-m1 { background: #ef4444; color: white; }
        .timeframe-d1-h4 { background: #8b5cf6; color: white; }
        .timeframe-h4-h1 { background: #6366f1; color: white; }
        .timeframe-m15-m3 { background: #ec4899; color: white; }
        
        .rr-strategy-1-1 { background: #f59e0b; color: white; }
        .rr-strategy-1-2 { background: #10b981; color: white; }
        .rr-strategy-upgraded { background: #22d3ee; color: white; }
        
        .robot-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            color: white;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .process-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            overflow-x: auto;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .process-step {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 140px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .process-step:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .process-step.active {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .process-arrow {
            font-size: 1.5rem;
            color: #3b82f6;
            margin: 0 10px;
        }
        
        .weekly-performance {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .weekly-performance.positive {
            background: linear-gradient(135deg, #d1fae5 0%, #10b981 100%);
            border-color: #10b981;
            color: white;
        }
        
        .break-even-indicator {
            background: linear-gradient(135deg, #e0e7ff 0%, #6366f1 100%);
            border: 1px solid #6366f1;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .fox-branding {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
        }
        
        .fox-branding a {
            color: #1e3c72;
            text-decoration: none;
            font-weight: 600;
        }
        
        .fox-branding a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .process-flow {
                flex-direction: column;
            }
            
            .process-arrow {
                transform: rotate(90deg);
                margin: 10px 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-24">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="mikrobot-logo">
                            <img src="{% static 'images/Mikrobot.jpg' %}" alt="MikroBot" class="w-16 h-16">
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">MikroBot</h1>
                            <p class="text-sm text-gray-500">Smart Microscale Trading</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center text-sm">
                            <div class="status-indicator {% if system_status.django %}status-online{% else %}status-offline{% endif %}"></div>
                            <span class="text-gray-700">Django</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="status-indicator {% if system_status.mt5 %}status-online{% else %}status-offline{% endif %}"></div>
                            <span class="text-gray-700">MT5</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="status-indicator {% if system_status.mcp %}status-online{% else %}status-offline{% endif %}"></div>
                            <span class="text-gray-700">MCP</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="status-indicator {% if system_status.llm %}status-online{% else %}status-offline{% endif %}"></div>
                            <span class="text-gray-700">LLM</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="status-indicator {% if system_status.pure_ea %}status-online{% else %}status-offline{% endif %}"></div>
                            <span class="text-gray-700">PURE EA</span>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <button class="relative p-2 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-bell text-xl"></i>
                            {% if notifications %}
                                {% with unread_count=notifications|length %}
                                    {% if unread_count > 0 %}
                                        <span class="notification-badge">{{ unread_count }}</span>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </button>
                    </div>
                    
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6 flex space-x-4">
            <a href="{% url 'dashboard:index' %}" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">🏠 Home</a>
            <a href="{% url 'dashboard:dashboard' %}" class="px-4 py-2 rounded-lg bg-blue-600 text-white">📊 Dashboard</a>
            <a href="{% url 'dashboard:settings' %}" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">⚙️ Settings</a>
            <a href="{% url 'dashboard:qa_dashboard' %}" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">🧪 QA</a>
            <a href="/admin/" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">🔧 Admin</a>
        </div>
        
        
        <!-- Omat Asetukset -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-cog mr-3 text-blue-600"></i>
                    Omat Asetukset
                </h2>
                <a href="{% url 'dashboard:settings' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-edit mr-2"></i>Muokkaa
                </a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <!-- Currency Pair -->
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-coins text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">Valuuttapari</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{ user_settings.currency_pair }}</div>
                    <div class="text-xs text-gray-500 mt-1">Kaupankäynnin kohde</div>
                </div>
                
                <!-- Risk Percentage -->
                <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl border border-green-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">Riski per Kauppa</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{ user_settings.risk_percentage }}%</div>
                    <div class="text-xs text-gray-500 mt-1">Tilin saldosta</div>
                </div>
                
                <!-- Stop Loss -->
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-stop-circle text-orange-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">Stop Loss</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{ user_settings.stop_loss_level }}</div>
                    <div class="text-xs text-gray-500 mt-1">Fibonacci taso</div>
                </div>
                
                <!-- ADX Indicator -->
                <div class="{% if user_settings.adx_value > 25 %}bg-gradient-to-r from-green-50 to-green-100 border-green-200{% elif user_settings.adx_value == 25 %}bg-gradient-to-r from-yellow-50 to-yellow-100 border-yellow-200{% else %}bg-gradient-to-r from-red-50 to-red-100 border-red-200{% endif %} p-4 rounded-xl border">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-line {% if user_settings.adx_value > 25 %}text-green-600{% elif user_settings.adx_value == 25 %}text-yellow-600{% else %}text-red-600{% endif %} mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">ADX Arvo</span>
                        <div class="ml-2 w-2 h-2 rounded-full {% if user_settings.adx_value > 25 %}bg-green-500{% elif user_settings.adx_value == 25 %}bg-yellow-500{% else %}bg-red-500{% endif %}"></div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{ user_settings.adx_value|default:24 }}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        {% if user_settings.adx_value > 25 %}
                            Vahva trendi ✓
                        {% elif user_settings.adx_value == 25 %}
                            Kynnysarvo
                        {% else %}
                            Heikko trendi
                        {% endif %}
                    </div>
                </div>

                <!-- Weekly Profit Threshold -->
                <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">R:R Strategy</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">{{ user_settings.weekly_profit_threshold }}%</div>
                    <div class="text-xs text-gray-500 mt-1">
                        <div>• 1:1 → BE+{{ user_settings.break_even_buffer_pips }}p</div>
                        <div>• {{ user_settings.weekly_profit_threshold }}% viikko → 1:2 R:R</div>
                    </div>
                </div>

                <!-- Break-Even Buffer -->
                <div class="bg-gradient-to-r from-teal-50 to-teal-100 p-4 rounded-xl border border-teal-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-equals text-teal-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">Break-Even</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">+{{ user_settings.break_even_buffer_pips }}</div>
                    <div class="text-xs text-gray-500 mt-1">Pips buffer</div>
                </div>

                <!-- Trading Sessions -->
                <div class="bg-gradient-to-r from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-globe text-emerald-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-600">Trading Sessions</span>
                    </div>
                    <div class="text-sm font-bold text-gray-900 space-y-1" style="font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;">
                        {% if user_settings.trade_london %}<div><span class="mr-2">🇬🇧</span>London (10:00-19:00)</div>{% endif %}
                        {% if user_settings.trade_new_york %}<div><span class="mr-2">🇺🇸</span>New York (15:30-00:30)</div>{% endif %}
                        {% if user_settings.trade_tokyo %}<div><span class="mr-2">🇯🇵</span>Tokyo (03:00-12:00)</div>{% endif %}
                        {% if not user_settings.trade_london and not user_settings.trade_new_york and not user_settings.trade_tokyo %}<div>🚫 No Active Sessions</div>{% endif %}
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        {% if user_settings.trade_london and user_settings.trade_new_york %}Overlap 15:30-17:00{% elif user_settings.trade_london %}European hours{% elif user_settings.trade_new_york %}American hours{% elif user_settings.trade_tokyo %}Asian hours{% else %}Trading disabled{% endif %}
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Aktiiviset asetukset:</strong> Kaikki uudet signaalit käyttävät näitä valintojasi. Muokkaa asetuksia tarpeen mukaan.
                </p>
            </div>
        </div>

        <!-- Account Summary -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card card-hover rounded-2xl p-6 text-white smooth-enter">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Balance</p>
                        <p class="text-2xl font-bold number-counter">${{ account_info.balance }}</p>
                    </div>
                    <div class="bg-blue-500 p-3 rounded-full">
                        <i class="fas fa-wallet text-white"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card card-hover rounded-2xl p-6 text-white smooth-enter">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Equity</p>
                        <p class="text-2xl font-bold number-counter">${{ account_info.equity }}</p>
                    </div>
                    <div class="bg-green-500 p-3 rounded-full">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card card-hover rounded-2xl p-6 text-white smooth-enter">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Free Margin</p>
                        <p class="text-2xl font-bold number-counter">${{ account_info.free_margin }}</p>
                    </div>
                    <div class="bg-purple-500 p-3 rounded-full">
                        <i class="fas fa-coins text-white"></i>
                    </div>
                </div>
            </div>
            
            <div class="metric-card card-hover rounded-2xl p-6 text-white smooth-enter">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Profit</p>
                        <p class="text-2xl font-bold number-counter {% if account_info.profit >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            ${{ account_info.profit }}
                        </p>
                    </div>
                    <div class="{% if account_info.profit >= 0 %}bg-green-500{% else %}bg-red-500{% endif %} p-3 rounded-full">
                        <i class="fas {% if account_info.profit >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %} text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Performance -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-calendar-week mr-3 text-orange-600"></i>
                    Weekly R:R Performance
                </h2>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    10% threshold for 1:2 upgrade
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% for symbol, data in account_info.weekly_performance.items %}
                    <div class="p-4 rounded-xl border-2 transition-all {% if data.upgraded %}bg-green-50 border-green-200{% else %}bg-gray-50 border-gray-200{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-gray-900">{{ symbol }}</span>
                            {% if data.upgraded %}
                                <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                    ⚡ 1:2 R:R
                                </span>
                            {% endif %}
                        </div>
                        <div class="text-2xl font-bold text-gray-900 mb-1">
                            {{ data.pct }}%
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ data.trades }} trades this week
                        </div>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full {% if data.pct >= 10 %}bg-green-500{% else %}bg-yellow-500{% endif %}" 
                                 style="width: {% if data.pct %}{{ data.pct|floatformat:0 }}{% else %}5{% endif %}%"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <!-- Active Trades -->
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-chart-line mr-3 text-blue-600"></i>
                            Active Trades
                        </h2>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            {{ trades|length }} Open
                        </span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Symbol</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Type</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Volume</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Timeframe</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">R:R Strategy</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Current P&L</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Weekly %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                    <tr class="trade-row border-b border-gray-50" data-trade-id="{{ trade.id }}">
                                        <td class="py-4 px-4 font-medium text-gray-900">{{ trade.symbol }}</td>
                                        <td class="py-4 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if trade.type == 'BUY' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                {{ trade.type }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-gray-700">{{ trade.volume }}</td>
                                        <td class="py-4 px-4">
                                            <span class="timeframe-badge {% if trade.timeframe == 'H1/M15' %}timeframe-h1-m15{% else %}timeframe-m15-m5{% endif %}">
                                                {{ trade.timeframe }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if trade.rr_strategy == '1:2' %}rr-strategy-1-2{% else %}rr-strategy-1-1{% endif %}">
                                                {{ trade.rr_strategy }}
                                            </span>
                                            {% if trade.break_even %}
                                                <div class="break-even-indicator mt-1">
                                                    BE: {{ trade.break_even }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="py-4 px-4">
                                            <span class="trade-profit font-medium number-counter {% if trade.profit >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                ${{ trade.profit }}
                                            </span>
                                            <div class="trade-pips text-xs text-gray-500 mt-1">
                                                {{ trade.profit_pips|default:"+0.0" }} pips
                                            </div>
                                            <div class="current-price text-xs text-gray-400">
                                                Current: {{ trade.current_price }}
                                            </div>
                                            {% if trade.stop_loss > 0 %}
                                            <div class="text-xs text-red-500 mt-1">
                                                SL: {{ trade.stop_loss }}
                                            </div>
                                            {% endif %}
                                            {% if trade.take_profit > 0 %}
                                            <div class="text-xs text-green-500">
                                                TP: {{ trade.take_profit }}
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="py-4 px-4">
                                            <span class="font-medium {% if trade.weekly_pnl >= 10 %}text-green-600{% else %}text-yellow-600{% endif %}">
                                                {{ trade.weekly_pnl }}%
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trade History -->
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-history mr-3 text-purple-600"></i>
                            Trade History
                        </h2>
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                            Last 7 Days
                        </span>
                    </div>
                    
                    {% if closed_trades %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Symbol</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Type</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Volume</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Entry/Exit</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">P&L Result</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Duration</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-700">Exit Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in closed_trades %}
                                    <tr class="border-b border-gray-50">
                                        <td class="py-4 px-4 font-medium text-gray-900">{{ trade.symbol }}</td>
                                        <td class="py-4 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if trade.type == 'BUY' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                {{ trade.type }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-gray-700">{{ trade.volume }}</td>
                                        <td class="py-4 px-4">
                                            <div class="text-sm">
                                                <div>Open: {{ trade.open_price }}</div>
                                                <div>Close: {{ trade.close_price }}</div>
                                            </div>
                                        </td>
                                        <td class="py-4 px-4">
                                            <span class="font-semibold {% if trade.profit >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {% if trade.profit >= 0 %}+{% endif %}${{ trade.profit }}
                                            </span>
                                        </td>
                                        <td class="py-4 px-4 text-sm text-gray-600">
                                            {{ trade.duration_minutes }} min
                                        </td>
                                        <td class="py-4 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                                {% if trade.reason == 'SL' %}bg-red-100 text-red-800{% elif trade.reason == 'TP' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ trade.reason }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-chart-line text-4xl mb-4 text-gray-300"></i>
                        <p>No closed trades in the last 7 days</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Signals List -->
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-signal mr-3 text-green-600"></i>
                            Trading Signals
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                New Signal
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-sync mr-2"></i>
                                Sync PURE EA
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        {% for signal in signals %}
                            <div class="signal-item p-4 border border-gray-200 rounded-xl">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-bold text-gray-900">{{ signal.symbol }}</span>
                                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if signal.direction == 'BUY' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                {{ signal.direction }}
                                            </span>
                                            {% if signal.source %}
                                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                                {% if signal.source == 'STS_SIGNALS' %}bg-blue-100 text-blue-800
                                                {% elif signal.source == 'DISCORD' %}bg-indigo-100 text-indigo-800
                                                {% elif signal.source == 'MANUAL_TEST' %}bg-gray-100 text-gray-800  
                                                {% elif signal.source == 'TEST' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-purple-100 text-purple-800{% endif %}">
                                                {% if signal.source == 'STS_SIGNALS' %}📊 STS
                                                {% else %}📡 {{ signal.source }}{% endif %}
                                            </span>
                                            {% endif %}
                                            <span class="timeframe-badge {% if signal.timeframe == 'H1/M15' %}timeframe-h1-m15{% else %}timeframe-m15-m5{% endif %}">
                                                {{ signal.timeframe }}
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-sm text-gray-600">Strength:</span>
                                            <span class="font-medium text-blue-600">{% widthratio signal.strength 1 100 %}%</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium 
                                            {% if signal.status == 'pending' %}bg-yellow-100 text-yellow-800
                                            {% elif signal.status == 'approved' %}bg-green-100 text-green-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ signal.status }}
                                        </span>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium {% if signal.rr_strategy == '1:2' %}rr-strategy-1-2{% else %}rr-strategy-1-1{% endif %}">
                                            {{ signal.rr_strategy }} R:R
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                    <div class="text-sm text-gray-600">
                                        <div class="flex justify-between">
                                            <span>Entry:</span>
                                            <span class="font-medium">{{ signal.entry }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Stop Loss:</span>
                                            <span class="font-medium">{{ signal.sl }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Take Profit:</span>
                                            <span class="font-medium">{{ signal.tp }}</span>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <div class="flex justify-between">
                                            <span>Weekly Performance:</span>
                                            <span class="font-medium {% if signal.weekly_performance >= 10 %}text-green-600{% else %}text-yellow-600{% endif %}">
                                                {{ signal.weekly_performance }}%
                                            </span>
                                        </div>
                                        {% if signal.llm_analysis.break_even_price %}
                                            <div class="flex justify-between">
                                                <span>Break Even:</span>
                                                <span class="font-medium text-blue-600">{{ signal.llm_analysis.break_even_price }}</span>
                                            </div>
                                        {% endif %}
                                        <div class="flex justify-between">
                                            <span>Confidence:</span>
                                            <span class="font-medium">{% widthratio signal.llm_analysis.confidence 1 100 %}%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-lg mb-3">
                                    <div class="text-sm text-gray-700">
                                        <div class="flex items-center mb-1">
                                            <i class="fas fa-robot mr-2 text-blue-600"></i>
                                            <span class="font-medium">LLM Analysis:</span>
                                        </div>
                                        <p class="text-gray-600">{{ signal.llm_analysis.reasoning }}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-500">{{ signal.timestamp }}</span>
                                    <div class="flex items-center space-x-2">
                                        {% if signal.status == 'pending' %}
                                            <button onclick="approveSignal('{{ signal.id }}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                                <i class="fas fa-check mr-1"></i>
                                                Approve
                                            </button>
                                        {% endif %}
                                        {% if signal.status == 'approved' %}
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-sm font-medium">
                                                <i class="fas fa-check mr-1"></i>
                                                Approved
                                            </span>
                                        {% endif %}
                                        <button onclick="editSignal('{{ signal.id }}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-cog mr-1"></i>
                                            Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover smooth-enter">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-bolt mr-3 text-yellow-600"></i>
                        Quick Actions
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-plus text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">Execute Signal</p>
                            <p class="text-sm opacity-80">Send to MT5</p>
                        </button>
                        
                        <button class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-sync-alt text-2xl mb-2 group-hover:rotate-180 transition-transform"></i>
                            <p class="font-medium">Sync PURE EA</p>
                            <p class="text-sm opacity-80">Update Timeframes</p>
                        </button>
                        
                        <button class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-robot text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">LLM Analysis</p>
                            <p class="text-sm opacity-80">Run GPT-4</p>
                        </button>
                        
                        <button class="bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-chart-line text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">R:R Strategy</p>
                            <p class="text-sm opacity-80">1:1→BE | {{ user_settings.weekly_profit_threshold }}%→1:2</p>
                        </button>
                        
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-brain text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">MCP Decision</p>
                            <p class="text-sm opacity-80">Kafka + Hansei</p>
                        </button>
                        
                        <button class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl text-center transition-colors group">
                            <i class="fas fa-times-circle text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">Emergency Stop</p>
                            <p class="text-sm opacity-80">Close All</p>
                        </button>
                        
                        <a href="{% url 'dashboard:settings' %}" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-xl text-center transition-colors group block">
                            <i class="fas fa-cog text-2xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="font-medium">Settings</p>
                            <p class="text-sm opacity-80">Risk & Currency</p>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <!-- System Status -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover smooth-enter">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-server mr-3 text-gray-600"></i>
                        System Status
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.django %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">Django API</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.django %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.django %}Online{% else %}Offline{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.mt5 %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">MetaTrader 5</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.mt5 %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.mt5 %}Connected{% else %}Disconnected{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.mcp %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">MCP Server</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.mcp %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.mcp %}Running{% else %}Stopped{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.llm %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">LLM (GPT-4)</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.llm %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.llm %}Ready{% else %}Error{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.pure_ea %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">PURE EA</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.pure_ea %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.pure_ea %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full {% if system_status.timeframe_sync %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                                <span class="font-medium text-gray-900">Timeframe Sync</span>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {% if system_status.timeframe_sync %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if system_status.timeframe_sync %}Synced{% else %}Out of sync{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- STS Signals (Simple Trading Solutions) -->
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover smooth-enter mt-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-satellite-dish mr-3 text-blue-600"></i>
                        STS Signals (Simple Trading Solutions)
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium" id="sts-status">Active</span>
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Performance Summary -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-900" id="sts-total-signals">0</div>
                                    <div class="text-sm text-blue-700">Total Signals</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600" id="sts-win-rate">0%</div>
                                    <div class="text-sm text-blue-700">Win Rate</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-indigo-600" id="sts-profit">+0.00</div>
                                    <div class="text-sm text-blue-700">Total P&L</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent STS Signals -->
                        <div class="space-y-3" id="sts-signals-list">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-signal text-3xl mb-2"></i>
                                <p>Waiting for STS signals...</p>
                                <p class="text-sm">Signals from Simple Trading Solutions will appear here</p>
                            </div>
                        </div>
                        
                        <!-- Connection Status -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Discord Connection:</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-600 font-medium">Connected</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-sm mt-2">
                                <span class="text-gray-600">Last Update:</span>
                                <span class="text-gray-900 font-medium" id="sts-last-update">Never</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="flex items-center space-x-3">
                    <div class="mikrobot-logo">
                        <img src="{% static 'images/Mikrobot.jpg' %}" alt="MikroBot" class="w-12 h-12">
                    </div>
                    <div>
                        <div class="text-lg font-bold text-gray-900">MikroBot</div>
                        <div class="text-sm text-gray-600">Smart Microscale Trading</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <h4 class="font-semibold text-gray-900 mb-2">Documentation</h4>
                    <p class="text-sm text-gray-600">Version 2.0 - Dynamic R:R Strategy</p>
                    <p class="text-sm text-gray-600">Updated: {% now "d.m.Y" %}</p>
                </div>
                
                <div class="fox-branding">
                    <div>Powered by <a href="https://www.foxinthecode.fi" target="_blank">Fox-In-The-Code</a></div>
                    <div>Support: <a href="mailto:markus@foxinthecode.fi">markus@foxinthecode.fi</a></div>
                    <div class="text-xs text-gray-500 mt-2">© 2025 Fox-In-The-Code. All rights reserved.</div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Live Data Updates -->
    <script>
    let updateInterval;
    let lastUpdateTime = 0;
    
    function updateLiveData() {
        fetch('/dashboard/api/live-data/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTrades(data.data.trades);
                    updateAccount(data.data.account);
                    updateSTSSignals(data.data.sts_signals || []);
                    lastUpdateTime = data.data.timestamp;
                    
                    // Update timestamp display
                    const statusDot = document.querySelector('.status-indicator .w-3');
                    const statusText = document.querySelector('.status-text');
                    if (statusDot && statusText) {
                        statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                        statusText.className = 'status-text px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                        statusText.textContent = `Online - ${new Date().toLocaleTimeString()}`;
                    }
                }
            })
            .catch(error => {
                console.error('Live data update failed:', error);
                const statusDot = document.querySelector('.status-indicator .w-3');
                const statusText = document.querySelector('.status-text');
                if (statusDot && statusText) {
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                    statusText.className = 'status-text px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    statusText.textContent = 'Connection Error';
                }
            });
    }
    
    function updateTrades(trades) {
        // Update each trade row with new data
        trades.forEach(trade => {
            const row = document.querySelector(`[data-trade-id="${trade.id}"]`);
            if (row) {
                // Update current price
                const priceElement = row.querySelector('.current-price');
                if (priceElement) {
                    priceElement.textContent = trade.current_price.toFixed(5);
                }
                
                // Update P&L
                const profitElement = row.querySelector('.trade-profit');
                if (profitElement) {
                    const profitColor = trade.profit >= 0 ? 'text-green-600' : 'text-red-600';
                    profitElement.className = `trade-profit font-semibold ${profitColor}`;
                    profitElement.textContent = `$${trade.profit.toFixed(2)}`;
                }
                
                // Update pips
                const pipsElement = row.querySelector('.trade-pips');
                if (pipsElement) {
                    const pipsColor = trade.profit_pips >= 0 ? 'text-green-600' : 'text-red-600';
                    pipsElement.className = `trade-pips text-sm ${pipsColor}`;
                    pipsElement.textContent = `${trade.profit_pips > 0 ? '+' : ''}${trade.profit_pips} pips`;
                }
            }
        });
    }
    
    function updateAccount(account) {
        // Update account balance
        const balanceElement = document.querySelector('.account-balance');
        if (balanceElement && account.balance) {
            balanceElement.textContent = `$${account.balance.toFixed(2)}`;
        }
        
        // Update equity
        const equityElement = document.querySelector('.account-equity');
        if (equityElement && account.equity) {
            equityElement.textContent = `$${account.equity.toFixed(2)}`;
        }
        
        // Update profit
        const profitElement = document.querySelector('.account-profit');
        if (profitElement && account.profit !== undefined) {
            const profitColor = account.profit >= 0 ? 'text-green-600' : 'text-red-600';
            profitElement.className = `account-profit font-semibold ${profitColor}`;
            profitElement.textContent = `$${account.profit.toFixed(2)}`;
        }
    }
    
    function updateSTSSignals(stsSignals) {
        // Update STS signals performance metrics
        const totalSignalsEl = document.getElementById('sts-total-signals');
        const winRateEl = document.getElementById('sts-win-rate');
        const profitEl = document.getElementById('sts-profit');
        const lastUpdateEl = document.getElementById('sts-last-update');
        const signalsListEl = document.getElementById('sts-signals-list');
        
        if (stsSignals && stsSignals.length > 0) {
            // Calculate performance metrics
            const totalSignals = stsSignals.length;
            const completedSignals = stsSignals.filter(s => s.status === 'completed' || s.status === 'closed');
            const winningSignals = completedSignals.filter(s => s.profit > 0);
            const winRate = completedSignals.length > 0 ? (winningSignals.length / completedSignals.length * 100) : 0;
            const totalProfit = completedSignals.reduce((sum, s) => sum + (s.profit || 0), 0);
            
            // Update metrics
            if (totalSignalsEl) totalSignalsEl.textContent = totalSignals;
            if (winRateEl) winRateEl.textContent = `${winRate.toFixed(1)}%`;
            if (profitEl) {
                const profitClass = totalProfit >= 0 ? 'text-green-600' : 'text-red-600';
                profitEl.className = `text-2xl font-bold ${profitClass}`;
                profitEl.textContent = `${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)}`;
            }
            if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleTimeString();
            
            // Update signals list
            if (signalsListEl) {
                const recentSignals = stsSignals.slice(0, 5); // Show last 5 signals
                signalsListEl.innerHTML = recentSignals.map(signal => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 rounded-full ${
                                signal.status === 'approved' ? 'bg-green-500' :
                                signal.status === 'pending' ? 'bg-yellow-500' : 'bg-gray-500'
                            }"></div>
                            <div>
                                <div class="font-medium text-gray-900">${signal.symbol} ${signal.direction}</div>
                                <div class="text-sm text-gray-600">Entry: ${signal.entry}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium ${
                                signal.profit > 0 ? 'text-green-600' : 
                                signal.profit < 0 ? 'text-red-600' : 'text-gray-600'
                            }">
                                ${signal.profit ? (signal.profit > 0 ? '+' : '') + signal.profit.toFixed(2) : 'Pending'}
                            </div>
                            <div class="text-xs text-gray-500">${signal.status}</div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            // No signals - show waiting message
            if (signalsListEl && !signalsListEl.innerHTML.includes('Waiting for STS signals')) {
                signalsListEl.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-signal text-3xl mb-2"></i>
                        <p>Waiting for STS signals...</p>
                        <p class="text-sm">Signals from Simple Trading Solutions will appear here</p>
                    </div>
                `;
            }
            if (lastUpdateEl) lastUpdateEl.textContent = 'Never';
        }
    }
    
    // Start live updates when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Add status indicator to system status section
        const systemStatusContainer = document.querySelector('.space-y-4');
        if (systemStatusContainer) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-indicator flex items-center justify-between p-4 bg-blue-50 rounded-xl';
            statusDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span class="font-medium text-gray-900">Live Updates</span>
                </div>
                <span class="status-text px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Connecting...</span>
            `;
            systemStatusContainer.insertBefore(statusDiv, systemStatusContainer.firstChild);
        }
        
        // Start updates every 2 seconds
        updateLiveData(); // Initial update
        updateInterval = setInterval(updateLiveData, 2000);
    });
    
    // Stop updates when page is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            clearInterval(updateInterval);
        } else {
            updateLiveData();
            updateInterval = setInterval(updateLiveData, 2000);
        }
    });
    
    // Signal management functions
    function approveSignal(signalId) {
        if (!confirm('Are you sure you want to approve this signal? It will be executed automatically.')) {
            return;
        }
        
        fetch(`/admin/signals/mql5signal/${signalId}/change/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `status=approved&_save=Save`
        })
        .then(response => {
            if (response.ok) {
                alert('Signal approved! Trade will be executed automatically.');
                location.reload();
            } else {
                alert('Failed to approve signal. Please try via Admin panel.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error approving signal. Please use Admin panel.');
        });
    }
    
    function editSignal(signalId) {
        // Redirect to admin edit page
        window.open(`/admin/signals/mql5signal/${signalId}/change/`, '_blank');
    }
    
    // Get CSRF token for Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
</body>
</html>